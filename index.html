<!DOCTYPE html>
<html lang="es">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Monitor de Olas de Calor</title>

    <script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/tone/14.8.49/Tone.js"></script>
    <script src="https://app.protobject.com/framework/p.js"></script>
    <script src="config.js"></script>

    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;700&display=swap" rel="stylesheet">

    <style>
      body {
        font-family: 'Inter', sans-serif;
        background-color: #fafafa;
        color: #333;
        margin: 0;
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        min-height: 100vh;
      }

      /* T√≠tulo unificado y limpio */
      h1 {
        font-weight: 700;
        font-size: 1.8rem;
        margin-bottom: 20px;
        color: #d35400; /* Naranja quemado */
        text-transform: uppercase;
        letter-spacing: 1px;
        text-align: center;
      }

      #chart-container {
        width: 90%;
        max-width: 1000px;
        height: 600px;
        box-shadow: 0 15px 40px rgba(0,0,0,0.08);
        border-radius: 16px;
        overflow: hidden;
        background: white;
        border: 1px solid #eee;
      }

      .controls {
        margin-top: 30px;
      }

      button {
        background-color: #2c3e50;
        color: white;
        border: none;
        padding: 14px 30px;
        font-size: 1rem;
        font-weight: 600;
        border-radius: 50px; /* Bot√≥n redondeado moderno */
        cursor: pointer;
        transition: all 0.3s ease;
        box-shadow: 0 4px 15px rgba(0,0,0,0.2);
      }

      button:hover {
        background-color: #d35400;
        transform: translateY(-2px);
        box-shadow: 0 6px 20px rgba(211, 84, 0, 0.4);
      }

      button:disabled {
        background-color: #95a5a6;
        cursor: not-allowed;
        transform: none;
        box-shadow: none;
      }

      /* Ocultar barra de herramientas de Plotly */
      .modebar {
        display: none !important;
      }
    </style>
  </head>
  <body>

    <h1>Registro Hist√≥rico de Aridez (RM)</h1>

    <div id="chart-container"></div>

    <div class="controls">
      <button id="startBtn">Iniciar Experiencia Sensorial</button>
    </div>

    <script>
      // --- CONFIGURACI√ìN ---
      const DATA_FILE = 'heatwaves_timeseries.json';
      const STEP_DURATION = 3000; // 3 segundos por a√±o
      const MIN_VAL = 3;
      const MAX_VAL = 50; 

      // --- AUDIO ENGINE ---
      let windNoise, windFilter, windVol;

      function setupAudio() {
        windNoise = new Tone.Noise("pink");
        windFilter = new Tone.Filter(200, "lowpass");
        windVol = new Tone.Volume(-20);
        windNoise.connect(windVol);
        windVol.connect(windFilter);
        windFilter.toDestination();
      }

      function updateAudio(value) {
        if (!windNoise) return;
        let norm = (value - MIN_VAL) / (MAX_VAL - MIN_VAL);
        norm = Math.max(0, Math.min(1, norm)); 
        const targetFreq = 200 + (norm * 2800); 
        const targetVol = -20 + (norm * 10); 
        windFilter.frequency.rampTo(targetFreq, STEP_DURATION / 1000);
        windVol.volume.rampTo(targetVol, STEP_DURATION / 1000);
      }

      // --- VISUALIZACI√ìN ---
      async function main() {
        const response = await fetch(DATA_FILE);
        const data = await response.json();
        
        const x = data.map(d => d.year);
        const y = data.map(d => d.heatwaves);

        // CALCULO DE ESTAD√çSTICAS PARA EL TOOLTIP INTENSO
        // Calculamos el promedio de olas de calor de todo el periodo
        const sum = y.reduce((a, b) => a + b, 0);
        const avg = (sum / y.length).toFixed(1);

        // Generamos textos personalizados para cada punto
        const customTexts = y.map(val => {
            const diff = ((val - avg) / avg) * 100; // Porcentaje de diferencia
            const diffStr = diff > 0 ? `+${diff.toFixed(0)}%` : `${diff.toFixed(0)}%`;
            
            let status = "";
            if (val > 30) status = "üî• PELIGRO CR√çTICO";
            else if (val > 18) status = "‚ö†Ô∏è ALTA INTENSIDAD";
            else status = "‚úÖ NIVEL ESTABLE";

            // Retornamos un string con formato HTML para el tooltip
            return `Promedio: ${avg}<br>Desviaci√≥n: <b>${diffStr}</b><br><br><span style='font-size:1.2em; font-weight:bold;'>${status}</span>`;
        });

        const trace = {
          x: x,
          y: y,
          mode: 'lines+markers',
          text: customTexts, // Aqu√≠ inyectamos la info extra
          hovertemplate: 
            '<b>A√ëO %{x}</b><br>' +
            'Olas de Calor: <b style="font-size:1.1em; color:#d35400;">%{y}</b><br>' +
            '<i>%{text}</i>' + // Muestra el texto calculado arriba
            '<extra></extra>', // Oculta la etiqueta extra de Plotly
          line: { color: '#e67e22', width: 4, shape: 'spline' },
          marker: { 
            color: '#d35400', 
            size: 10,
            line: { color: 'white', width: 2 }
          },
          fill: 'tozeroy',
          fillcolor: 'rgba(230, 126, 34, 0.15)',
          type: 'scatter'
        };

        const layout = {
          font: { family: 'Inter, sans-serif' },
          // Quitamos el t√≠tulo interno del gr√°fico para evitar duplicados
          title: false,
          xaxis: { 
            showgrid: false, 
            zeroline: false,
            fixedrange: true,
            tickfont: { size: 14 }
          },
          yaxis: { 
            title: 'Eventos Registrados',
            titlefont: { size: 14, weight: 'bold' },
            gridcolor: '#f0f0f0', 
            zeroline: false,
            fixedrange: true 
          },
          margin: { t: 30, r: 50, b: 50, l: 70 },
          showlegend: false,
          hoverlabel: {
            bgcolor: "#333", // Fondo oscuro para el tooltip
            bordercolor: "#333",
            font: { color: "white", size: 13 } // Texto blanco
          }
        };

        const config = { displayModeBar: false, responsive: true };

        Plotly.newPlot('chart-container', [trace], layout, config);

        const btn = document.getElementById('startBtn');
        btn.addEventListener('click', async () => {
          btn.disabled = true;
          btn.innerText = "Simulando Ambiente...";
          
          await Tone.start();
          setupAudio();
          windNoise.start();

          for (let i = 0; i < y.length; i++) {
            const currentVal = y[i];
            const currentYear = x[i];

            // Animaci√≥n visual (Punto rojo grande y tooltip autom√°tico si se pudiera, pero Plotly no soporta tooltip forzado f√°cil)
            // Hacemos el punto GIGANTE cuando es un a√±o cr√≠tico
            const sizeCurrent = currentVal > 30 ? 35 : 20; // M√°s dramatismo visual
            
            const sizes = x.map((_, j) => (j === i ? sizeCurrent : 10));
            const colors = x.map((_, j) => (j === i ? '#c0392b' : '#d35400')); 
            
            // Efecto de parpadeo en la l√≠nea si es cr√≠tico (opcional, sutil cambio de opacidad)
            const opacity = currentVal > 30 ? 0.6 : 0.15;

            Plotly.restyle('chart-container', {
              'marker.size': [sizes],
              'marker.color': [colors],
              'fillcolor': [`rgba(230, 126, 34, ${opacity})`]
            }, [0]);

            if (typeof Protobject !== 'undefined') {
                Protobject.Core.send({
                    cant: currentVal,
                    year: currentYear
                }).to("arduino.html");
            }

            updateAudio(currentVal);

            await new Promise(r => setTimeout(r, STEP_DURATION));
          }

          windNoise.stop();
          btn.innerText = "Reiniciar Experiencia";
          btn.disabled = false;
        });
      }

      main();
    </script>
  </body>
</html>