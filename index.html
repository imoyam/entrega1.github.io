<!DOCTYPE html>
<html lang="es">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Monitor de Aridez - RM</title>

    <script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/tone/14.8.49/Tone.js"></script>
    <script src="https://app.protobject.com/framework/p.js"></script>
    <script src="config.js"></script>

    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;800&display=swap" rel="stylesheet">

    <style>
      body {
        font-family: 'Inter', sans-serif;
        background-color: #fafafa;
        color: #333;
        margin: 0;
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        min-height: 100vh;
        overflow-x: hidden;
      }

      header {
        text-align: center;
        margin-bottom: 20px;
        animation: fadeIn 1.5s ease;
      }

      h1 {
        font-weight: 800;
        font-size: 2rem;
        margin: 0;
        color: #d35400;
        text-transform: uppercase;
        letter-spacing: -1px;
      }

      p.intro {
        color: #666;
        font-size: 0.95rem;
        margin-top: 5px;
        font-weight: 300;
      }

      #chart-wrapper {
        position: relative;
        width: 90%;
        max-width: 1000px;
        height: 550px;
        background: white;
        border-radius: 12px;
        box-shadow: 0 20px 50px rgba(0,0,0,0.06);
        border: 1px solid #eaeaea;
        overflow: hidden;
      }

      #chart-container {
        width: 100%;
        height: 100%;
      }

      #progress-bar {
        position: absolute;
        bottom: 0;
        left: 0;
        height: 4px;
        background-color: #d35400;
        width: 0%;
        transition: width 0.5s linear;
        z-index: 10;
      }

      .controls {
        margin-top: 25px;
        z-index: 5;
      }

      button {
        background-color: #222;
        color: white;
        border: none;
        padding: 12px 35px;
        font-size: 0.9rem;
        font-weight: 600;
        border-radius: 4px;
        cursor: pointer;
        transition: all 0.3s ease;
        text-transform: uppercase;
        letter-spacing: 1px;
      }

      button:hover {
        background-color: #d35400;
        transform: translateY(-2px);
        box-shadow: 0 10px 20px rgba(211, 84, 0, 0.2);
      }

      button:disabled {
        background-color: #ccc;
        cursor: default;
        transform: none;
        box-shadow: none;
      }
      footer {
        margin-top: 40px;
        font-size: 0.75rem;
        color: #888;
        text-align: center;
        border-top: 1px solid #eee;
        padding-top: 15px;
        width: 80%;
        max-width: 800px;
        line-height: 1.6;
      }

      footer strong { color: #555; }
      
      .methodology-note {
        display: block;
        margin-top: 5px;
        font-style: italic;
        color: #d35400;
      }

      @keyframes fadeIn {
        from { opacity: 0; transform: translateY(10px); }
        to { opacity: 1; transform: translateY(0); }
      }
    </style>
  </head>
  <body>

    <header>
      <h1>Olas de Calor</h1>
      <p class="intro">Evoluci√≥n de olas de calor extremas en la Regi√≥n Metropolitana (1995-2020)</p>
    </header>

    <div id="chart-wrapper">
      <div id="chart-container"></div>
      <div id="progress-bar"></div>
    </div>

    <div class="controls">
      <button id="startBtn">Iniciar Visualizaci√≥n</button>
    </div>

    <footer>
      <strong>Fuente de datos:</strong> Direcci√≥n Meteorol√≥gica de Chile (DMC).<br>
      <span id="method-text">Cargando datos hist√≥ricos...</span>
    </footer>

    <script>
      const DATA_FILE = 'heatwaves_timeseries.json';
      const STEP_DURATION = 3000; 
      const MIN_VAL = 3; 
      const MAX_VAL = 50; 
      let windNoise, windFilter, windVol;

      function setupAudio() {
        if(windNoise) return; 
        windNoise = new Tone.Noise("pink");
        windFilter = new Tone.Filter(200, "lowpass");
        windVol = new Tone.Volume(-20);
        windNoise.connect(windVol);
        windVol.connect(windFilter);
        windFilter.toDestination();
      }

      function updateAudio(value) {
        if (!windNoise) return;
        let norm = (value - MIN_VAL) / (MAX_VAL - MIN_VAL);
        norm = Math.max(0, Math.min(1, norm)); 
        
        const targetFreq = 200 + (norm * 3000); 
        const targetVol = -25 + (norm * 12); 
        
        windFilter.frequency.rampTo(targetFreq, STEP_DURATION / 1000);
        windVol.volume.rampTo(targetVol, STEP_DURATION / 1000);
      }
      async function main() {
        const response = await fetch(DATA_FILE);
        const data = await response.json();
        
        const x = data.map(d => d.year);
        const y = data.map(d => d.heatwaves);

        const maxVal = Math.max(...y);
        const maxIndex = y.indexOf(maxVal);
        const maxYear = x[maxIndex];
        const sum = y.reduce((a, b) => a + b, 0);
        const avg = parseFloat((sum / y.length).toFixed(1));
        const footerText = document.getElementById('method-text');
        footerText.innerHTML = `
          Definici√≥n de ola de calor seg√∫n percentil 90 de temperaturas m√°ximas diarias.<br>
          <span class="methodology-note">
            Nota: El porcentaje de variaci√≥n se calcula respecto al <strong>promedio hist√≥rico de ${avg} olas de calor</strong> por a√±o.
          </span>
        `;
        const customTexts = y.map(val => {
            const diff = ((val - avg) / avg) * 100;
            const diffStr = diff > 0 ? `+${diff.toFixed(0)}%` : `${diff.toFixed(0)}%`;
            
            let status = val > 30 ? "üî• CR√çTICO" : (val > 18 ? "‚ö†Ô∏è ALTO" : "‚úÖ NORMAL");
            return `Promedio Hist√≥rico (${avg}):<br>Variaci√≥n: <b>${diffStr}</b><br><br><span style='font-size:14px; font-weight:bold;'>${status}</span>`;
        });

        const trace = {
          x: x,
          y: y,
          mode: 'lines+markers',
          text: customTexts,
          hovertemplate: 
            '<b>A√ëO %{x}</b><br>' +
            'Olas de Calor: <b style="font-size:16px; color:#d35400;">%{y}</b><br>' +
            '<i>vs Promedio Hist√≥rico:</i> %{text}<extra></extra>',
          line: { color: '#e67e22', width: 3, shape: 'spline' },
          marker: { 
            color: '#d35400', 
            size: 8,
            line: { color: 'white', width: 1.5 }
          },
          fill: 'tozeroy',
          fillcolor: 'rgba(230, 126, 34, 0.08)',
          type: 'scatter'
        };

        const annotations = [{
            x: maxYear,
            y: maxVal,
            xref: 'x',
            yref: 'y',
            text: '<b>R√âCORD HIST√ìRICO</b>',
            showarrow: true,
            arrowhead: 2,
            ax: 0,
            ay: -40,
            font: { color: '#c0392b', size: 12, family: 'Inter' },
            arrowcolor: '#c0392b'
        }];

        const layout = {
          font: { family: 'Inter, sans-serif', color: '#444' },
          annotations: annotations,
          xaxis: { 
            showgrid: false, 
            zeroline: false, 
            fixedrange: true,
            tickfont: { size: 12, color: '#888' }
          },
          yaxis: { 
            title: 'N¬∞ de Olas de Calor',
            titlefont: { size: 12, color: '#888' },
            gridcolor: '#f5f5f5', 
            zeroline: false, 
            fixedrange: true 
          },
          margin: { t: 40, r: 40, b: 40, l: 60 },
          showlegend: false,
          hoverlabel: {
            bgcolor: "#222",
            bordercolor: "#222",
            font: { color: "white", family: "Inter" } 
          }
        };

        const config = { displayModeBar: false, responsive: true, staticPlot: false };

        Plotly.newPlot('chart-container', [trace], layout, config);

        const btn = document.getElementById('startBtn');
        const progressBar = document.getElementById('progress-bar');

        btn.addEventListener('click', async () => {
          btn.disabled = true;
          btn.innerText = "Simulando...";
          
          await Tone.start();
          setupAudio();
          windNoise.start();

          for (let i = 0; i < y.length; i++) {
            const currentVal = y[i];
            const currentYear = x[i];
            
            const isCritical = currentVal > 30;
            const sizeCurrent = isCritical ? 25 : 15;
            
            const sizes = x.map((_, j) => (j === i ? sizeCurrent : 8));
            const colors = x.map((_, j) => (j === i ? (isCritical ? '#c0392b' : '#e67e22') : '#edbb99'));

            Plotly.restyle('chart-container', {
              'marker.size': [sizes],
              'marker.color': [colors]
            }, [0]);

            const progress = ((i + 1) / y.length) * 100;
            progressBar.style.width = `${progress}%`;

            if (typeof Protobject !== 'undefined') {
                Protobject.Core.send({
                    cant: currentVal,
                    year: currentYear
                }).to("arduino.html");
            }

            updateAudio(currentVal);

            await new Promise(r => setTimeout(r, STEP_DURATION));
          }

          windNoise.stop();
          btn.innerText = "Reiniciar Visualizaci√≥n";
          btn.disabled = false;
           Plotly.restyle('chart-container', {
              'marker.size': [8], 
              'marker.color': ['#d35400'] 
            }, [0]);
           progressBar.style.width = '0%';
        });
      }

      main();
    </script>
  </body>
</html>