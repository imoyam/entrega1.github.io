<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<title>Olas de calor - Interactivo</title>
</head>

<style>
  body {
    font-family: Inter, Roboto, Arial, sans-serif;
    margin: 20px;
    background: #f7fbfc;
    color: #111;
    text-align: center;
  }
  #chart {
    width: 90%;
    height: 600px;
    margin: 0 auto;
  }
  .controls {
    margin-top: 20px;
    display: flex;
    justify-content: center;
    align-items: center;
    flex-wrap: wrap;
    gap: 10px;
  }
  button, input[type=checkbox] {
    margin: 5px;
    padding: 8px 14px;
    border-radius: 8px;
    border: 1px solid #ccc;
    background-color: #ffffff;
    cursor: pointer;
    font-size: 14px;
    transition: background 0.2s;
  }
  button:hover {
    background-color: #e6f2fa;
  }
  .info {
    margin-top: 20px;
    font-size: 14px;
    color: #333;
    text-align: left;
    width: 90%;
    margin-left: auto;
    margin-right: auto;
  }
</style>
<body>
  
<script src="https://cdn.plot.ly/plotly-2.24.1.min.js"></script>
<script src="https://unpkg.com/tone/build/Tone.js"></script>
  
<!-- NUEVO, se ejecutan archivos de configuración para Protobject -->
<script src="https://app.protobject.com/framework/p.js"></script>
<script src="config.js"></script>

<h2>Número de olas de calor por año — Región Metropolitana (1995-2020)</h2>
<div id="chart"></div>

<div class="controls">
  <button id="toggleCP">Mostrar quiebres</button>
  <button id="play">Play animación</button>
  <button id="playSound">Play con sonido</button>
  <label><input type="checkbox" id="showGrid" checked> Mostrar cuadrícula horizontal</label>
</div>

<div class="info" id="infoPanel">
  <strong>Metodología (resumen):</strong> Umbral = percentil 90 (1995-2010) por estación y día del año. <br>
  Olas = rachas ≥3 días sobre umbral. <br>
  Detección de quiebres: simple-year-diff-threshold (threshold=23.286637). Quiebres detectados: [2009, 2019].
</div>

<script>

// NUEVO, enviar datos iniciales
Protobject.Core.send({
    cant: 0,   // valor del punto actual
    year: 0
    }).to("arduino.html");
  
async function init() {
  const data = await fetch('heatwaves_timeseries.json').then(r=>r.json());
  const meta = await fetch('meta.json').then(r=>r.json());
  const x = data.map(d=>d.year);
  const y = data.map(d=>d.heatwaves);

  // Colores accesibles
  const trace = {
    x, y,
    mode: 'lines+markers',
    name: 'Olas de calor',
    marker: { size: 8, color: '#0072B2' }, // azul
    line: { color: '#E69F00', width: 2 }   // naranja
  };

  const layout = {
    title: 'Número de olas de calor por año - RM',
    xaxis: { title: 'Año', range: [1995, 2020], rangeslider: { visible: true } },
    yaxis: { title: 'Cantidad de olas de calor' },
    shapes: [],
    hovermode: 'closest',
    plot_bgcolor: '#f7fbfc',
    paper_bgcolor: '#f7fbfc'
  };

  await Plotly.newPlot('chart', [trace], layout, {responsive:true});

  // ---- Toggle quiebres ----
  let showCP = false;
  const baseShapes = [];
  const cpYears = meta.change_years || [];
  const cpShapes = cpYears.map(y => ({
    type: 'line',
    x0: y, x1: y, xref: 'x',
    y0: 0, y1: 1, yref: 'paper',
    line: { color: '#56B4E9', dash: 'dot', width: 2 }
  }));

  const btnCP = document.getElementById('toggleCP');
  btnCP.onclick = () => {
    showCP = !showCP;
    if (showCP) {
      Plotly.relayout('chart', { shapes: baseShapes.concat(cpShapes) });
      btnCP.textContent = "Ocultar quiebres";
    } else {
      Plotly.relayout('chart', { shapes: baseShapes });
      btnCP.textContent = "Mostrar quiebres";
    }
  };

  // ---- Animación general (sin o con sonido) ----
  async function playAnimation(withSound = false) {
    const minv = Math.min(...y);
    const maxv = Math.max(...y);

    let synth, bell;
    if (withSound) {
      await Tone.start();

      synth = new Tone.Synth({
        oscillator: { type: 'triangle' },
        envelope: { attack: 0.02, decay: 0.1, sustain: 0.3, release: 0.3 }
      }).toDestination();

      bell = new Tone.MetalSynth({
        frequency: 400,
        envelope: { attack: 0.001, decay: 0.1, release: 0.2 },
        harmonicity: 5.1,
        modulationIndex: 32,
        resonance: 4000,
        octaves: 1.5
      }).toDestination();

      const reverb = new Tone.Reverb({ decay: 2, wet: 0.3 }).toDestination();
      synth.connect(reverb);
    }

    // animación punto a punto
    for (let i = 0; i < y.length; i++) {
      const sizes = x.map((_, j) => (j === i ? 14 : 8));
      await Plotly.restyle('chart', {'marker.size':[sizes]}, [0]);

      // NUEVO, se envía info a arduino.html
      Protobject.Core.send({
      cant: y[i],   // valor del punto actual
      year: x[i]
      }).to("arduino.html");

      if (withSound) {
        const v = y[i];
        const norm = (v - minv) / (maxv - minv);
        const freq = 110 * Math.pow(2, norm * 3); // A2–A5
        const vol = -18 + norm * 10;
        synth.volume.value = vol;

        synth.triggerAttackRelease(freq, "8n");

        if (meta.change_years.includes(x[i])) {
          bell.triggerAttackRelease("C6", "16n", "+0.05");
        }
      }
      // NUEVO, se espera un segundo en vez de 1/4s para
      // evitar "golpes" en el motor
      await new Promise(r => setTimeout(r, 1000));
    }

    // reset marker size
    await Plotly.restyle('chart', {'marker.size': [x.map(_=>8)]}, [0]);
  }

  // Botones
  document.getElementById('play').onclick = () => playAnimation(false);
  document.getElementById('playSound').onclick = () => playAnimation(true);

  // ---- Grid toggle ----
  document.getElementById('showGrid').onchange = (e) => {
    const show = e.target.checked;
    Plotly.relayout('chart', {'yaxis.showgrid': show, 'xaxis.showgrid': false});
  };
}

init();
</script>
</body>
</html>
